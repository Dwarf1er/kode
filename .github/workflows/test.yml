name: Unit Tests ðŸ§ª

on:
  push:
    branches:
      - master

jobs:
  get_tests:
    name: Get Tests ðŸ”
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get_test.outputs.matrix }}
    steps:
      - uses: actions/checkout@v2
      - name: Get Tests
        id: get_test
        run: |
          cd ./tests && ls *.kode | sed 's/.\{5\}$//' | awk '{print "\""$1"\""}' | tr "\n" "," | sed 's/.$//' | awk '{print "::set-output name=matrix::{\"test_name\":["$1"]}"}'

  execute_all_tests:
    needs: get_tests
    name: Test ${{ matrix.test_name }} ðŸ”¬
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.get_tests.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v2
      - name: Run test
        run: |
          python3 run.py ./tests/${{ matrix.test_name }}.kode > ./result.log
      - name: Check test
        run: |
          cmp ./tests/${{ matrix.test_name }}.out ./result.log
